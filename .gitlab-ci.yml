stages:
  - test
  - build
  - publish

workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH

test:
  stage: test
  image: python:${PYTHON_VERSION}
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.11", "3.12", "3.13", "3.14"]
  script:
    - python -m pip install --upgrade pip
    - python -m pip install ".[dev]"
    - python -m pytest -q

build:
  stage: build
  image: python:3.11
  script:
    - python -m pip install --upgrade pip
    - python -m pip install build twine
    - |
      python - <<'PY'
      import os
      import tomllib
      from pathlib import Path

      pyproject = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
      version = pyproject["project"]["version"]

      tag = os.environ.get("CI_COMMIT_TAG", "")
      if tag.startswith("v"):
          tag_version = tag.removeprefix("v")
          if tag_version != version:
              raise SystemExit(f"Tag/version mismatch: tag={tag_version} vs version={version}")
      PY
    - python -m build
    - python -m twine check --strict dist/*
  artifacts:
    paths:
      - dist/*
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"

publish_testpypi:
  stage: publish
  image: python:3.11
  dependencies:
    - build
  script:
    - python -m pip install --upgrade pip twine
    - export TWINE_USERNAME="__token__"
    - export TWINE_PASSWORD="${TESTPYPI_API_TOKEN}"
    - export TWINE_REPOSITORY_URL="https://test.pypi.org/legacy/"
    - twine upload dist/*
  rules:
    - if: $CI_COMMIT_TAG
      when: manual

publish_pypi:
  stage: publish
  image: python:3.11
  dependencies:
    - build
  script:
    - python -m pip install --upgrade pip twine
    - export TWINE_USERNAME="__token__"
    - export TWINE_PASSWORD="${PYPI_API_TOKEN}"
    - twine upload dist/*
  rules:
    - if: $CI_COMMIT_TAG
